# k6 による負荷試験

## リソース割り当て

### CPU

- k6 は高度にマルチスレッド化されており利用可能なすべての CPU コアを効果的に利用する
- 必要な CPU の量は、テストスクリプトと関連ファイルによって異なる
- テスト ファイルに関係なく、大規模なテストでは大量の CPU が必要になる
- <u>少なくとも 20% のアイドル サイクルが発生するようにマシンのサイズを設定することが推奨されている</u>
  - 最大 80% が k6 によって使用され、20% がアイドル状態
    k6 が CPU の 100% を使用して負荷を生成すると、テストでスロットル制限が発生し、結果メトリクスの応答時間が実際よりも大幅に長くなる可能性がある

### RAM

- k6 は、他の負荷テストツールよりも効率的に大量のメモリを使用利用できる
- メモリ消費量はテストシナリオに依存する
- テストのメモリ要件を見積もるには、100VU を備えた開発マシンでテストを実行し、消費されたメモリに目標の VU 数を掛ける
- <u>単純なテストでは、VU あたり約 1 ~ 5 MB を使用</u>
  - 1000VU = 1 ~ 5 GB
- ファイルのアップロードを使用するテスト、または大きな JS モジュールをロードするテストでは、VU ごとに数十メガバイトを消費する可能性がある
- VU 毎にテストで使用するすべての JS モジュールのコピーが走る
- VU 間でメモリを共有するには、SharedArray または Redis などの外部データストアの使用を検討する必要がある
- <u>スワップ領域は無効にして使用する</u>
  - システムの物理メモリが不足すると、メモリをより低速なセカンダリストレージにスワップするプロセス（メモリスワップ）によって、パフォーマンスとシステムの安定性に不安定な影響が生じる可能性がある
  - テストの様々な部分で負荷生成のパフォーマンスが異なるため、テスト結果が無効になる可能性がある
- メモリ使用量が 90% を超えないように十分な物理 RAM を確保する

## 大規模負荷試験

- 単一の k6 プロセスは負荷生成マシン上のすべての CPU コアを効率的に使用する
- k6 は<u>単一インスタンスで 30,000 ~ 40,000 人の同時ユーザ数 (VU) を実行できる</u>
  - マシンの処理状況によっては、VU 数に応じて 1 秒あたり最大 300,000 の HTTP リクエスト（RPS）が生成される場合もある
- 1 秒あたり 100,000 ~ 300,000 リクエスト（1 分あたり 600 ~1200 万リクエスト）を超えるリクエストを必要としない限り、k6 の 1 つのインスタンスでニーズを満たせる場合もある

## 負荷試験レポートの可視化

### 外部ツールへの結果出力

- **Prometheus RW**
  - k6 はデータを Prometheus のスクレイパ形式でエクスポートすることで、Prometheus 自体がデータをスクレイピングして集約・保存できるようになる
  - Prometheus は指定された間隔で HTTP エンドポイントをスクレイピングしてメトリクスを収集する
- **InfluxDB**
  - k6 はデータを InfluxDB に直接送信するため、データを <u>InfluxDB のラインプロトコル形式に変換する必要がある</u>
  - ラインプロトコルはデータポイントを行ごとに表現するシンプルなテキスト形式
    - Prometheus RW と比較して InfluxDB がボトルネックとなる可能性もある

### メトリクスの保存とクエリ

- **Prometheus**
  - データをローカルに保存し、PromQL を使用してデータをクエリできる
  - PromQL を使用すると、メトリクスを柔軟にフィルタリング、集計、グラフ化できる
- **InfluxDB**
  - データをデータベースに保存して、InfluxQL または Flux を使用してデータをクエリできる
    - InfluxQL は SQL に似た構文を持ち、Flux はより柔軟で強力なクエリ言語を使用できる

### ツールの統合と可視化

- **Prometheus**
  - Prometheus はエコシステムが豊富であり、Grafana と統合してデータを可視化するのに便利
  - メトリクスデータを Grafana に流すことで、ダッシュボードを作成したりアラートを設定できる
- **InfluxDB**
  - InfluxDB も Grafana と統合でき、データの可視化に使用できる
  - InfluxDB には Chronograf（クロノグラフ）という可視化ツールがある

## 【その他】 InfluxDB は Version 1.8 を使用する

- xk6 を使用する場合において、InfluxDB Version 2.0 以降を使用する場合、自前でビルドする必要がある
  - https://github.com/grafana/xk6-output-influxdb

## 参考

- https://k6.io/docs/testing-guides/running-large-tests/
